# Project Architecture

This document captures the high-level structure, naming rules, and conventions for the *Health-Stats* code-base.

---

## 1. Directory Layout

```
.
├─ infra/                # Deployment + operational tooling (never imported by the app)
│  ├─ aws/               # CloudFormation / Lambda helpers
│  └─ scripts/           # One-off migration & data scripts
├─ public/               # Static assets served by Next.js
├─ src/
│  ├─ app/               # Next.js App-Router tree (pages, route handlers, RSC)
│  │  └─ api/            # HTTP route handlers only (no business logic)
│  ├─ components/        # Shared UI (cross-feature). Keep feature-owned UI in features/*
│  │  └─ ui/             # Low-level primitives (Card, Skeleton, Dialog…). Barrel in index.ts
│  ├─ features/          # Feature folders own their UI, hooks, and utils
│  ├─ providers/         # App-level providers (e.g., SessionProvider, ThemeProvider)
│  ├─ server/            # Server-only modules (no React) – business logic lives here
│  │  ├─ aws/            # S3, Lambda clients & helpers
│  │  ├─ payments/       # Stripe client & helpers
│  │  ├─ jobs/           # Background job persistence & status helpers
│  │  └─ processing/     # Long-running/processing flows (canonical imports)
│  ├─ db/                # Database client & schema constants (e.g., Mongo client)
│  ├─ lib/               # Shared utilities (pure helpers, auth config, parsing)
│  │  ├─ auth/           # Next-Auth config and helpers
│  │  └─ utils.ts        # UI-agnostic helpers (e.g., cn)
│  └─ types/             # Shared domain and API types (no ambient declarations)
├─ types/                # Ambient global .d.ts for third‑party modules (picked up via typeRoots)
└─ docs/                 # Internal documentation (you are here)
```

### Rules

1. **No business logic inside `src/app/api`.** Route handlers are thin. Real work lives in `src/server/*` (primary) or `src/features/*` (UI-adjacent helpers). `src/lib` is for shared, UI-agnostic utilities only.
2. **All directories are lowercase-kebab-case**, except Next.js dynamic segments (e.g. `[userId]`).
3. **Files use PascalCase** for React components, `camelCase` for helpers.

---

## 2. Path Aliases (tsconfig.json)

```jsonc
"paths": {
  "@/*":             ["./src/*"],
  "@components/*":   ["./src/components/*"],
  "@ui/*":           ["./src/components/*"],
  "@features/*":     ["./src/features/*"],
  "@lib/*":          ["./src/lib/*"],
  "@providers/*":    ["./src/providers/*"],
  "@server/*":       ["./src/server/*"],
  "@db/*":           ["./src/db/*"]
}
```
Use these instead of long relative paths.

---

## 3. Types

- `types/` (repo root): Ambient declarations only (e.g., NextAuth module augmentation, third‑party `.d.ts`). These are discovered via `typeRoots` in `tsconfig.json`.
- `src/types/`: Domain and API types used across the app (interfaces, unions, DTOs). No ambient declarations here.

---
### Plain‑English: why two "types" places?

- Root `types/` → think "tell TypeScript about libraries". Holds ambient `.d.ts` files that extend or describe third‑party modules. You don't import these; TypeScript finds them automatically.
- `src/types/` → think "our app's shapes". Regular `.ts` files you import everywhere for domain models and DTOs.
- `.next/types/` → generated by Next.js during build. Temporary helper types; never edit. We include it in `tsconfig` so Next.js' internals type-check correctly.
- There is no `src/app/types` in this project. If it appears, it's likely leftover and should be removed.

---

## 4. Component Guidelines

* Prefer **server components**; mark client components explicitly with `'use client'`.
* One component per file; export named components.
* Keep story/tests adjacent (`MyComp.test.tsx`, `MyComp.stories.tsx`).

### Feature ownership & barrels

- **Feature-owned UI** lives under `src/features/<feature>/components`. Avoid putting feature UI in `src/components`.
- Add a local barrel when helpful: `src/features/<feature>/components/index.ts`.
- Examples:

```ts
// Feature components (recommended)
import AddExperimentModal from '@features/experiments/components/AddExperimentModal';
import BloodTestUpload from '@features/blood-markers/components/BloodTestUpload';

// Shared primitives
import { ConfirmDialog } from '@components/ui';
```

### App providers

- App-level providers live in `src/providers`.
- Example usage in `src/app/layout.tsx`:

```tsx
import { SessionProvider } from '@providers/SessionProvider';
import { ThemeProvider } from '@providers/ThemeProvider';

// ...
<SessionProvider>
  <ThemeProvider>{children}</ThemeProvider>
</SessionProvider>
```

### Compatibility re-exports

- During migration, some files in `src/components/*` may re-export from `src/features/*` to avoid breaking legacy paths. Prefer importing from `@features/*` going forward.

---

## 5. Server Modules (`src/server`)

Server-only modules encapsulate integrations and domain logic. Prefer importing from these instead of calling SDKs directly in routes.

Examples:

```ts
// S3 helpers
import { listDataFiles, fetchAllHealthData } from '@/server/aws/s3';

// Stripe helpers
import stripe, { hasUserPurchasedProduct } from '@/server/payments/stripe';

// Background jobs
import { createProcessingJob, getProcessingJob } from '@/server/jobs/processingJobs';

// Lambda
import { invokeLambda } from '@/server/aws/lambda';

// DB client
import clientPromise from '@/db/client';
```

`src/server/index.ts` provides barrels if you want to group imports.

### Processing flows

- Canonical imports for processing live under `src/server/processing`.

```ts
import { processHealthData } from '@server/processing/processHealthData';
```

### Barrels & canonical imports

- Prefer importing from canonical modules (`@server/aws/s3`, `@server/payments/stripe`, `@db/client`, `@features/<feature>/components`).
- Add `index.ts` barrels in folders with multiple exports to keep imports ergonomic.

---

## 6. Styling & UI

* **Tailwind CSS** with a mobile-first approach.
* Radix UI + Shadcn for accessible primitives.
* Use utility classes; avoid custom CSS unless necessary.

---

## 7. Testing

* Jest + React Testing Library.
* Tests live next to code (e.g. `TrendIndicator.test.tsx`).

---

## 8. Scripts & Infrastructure

* All operational scripts live in `infra/scripts`.
* Cloud resources (Lambda bundle, policies) under `infra/aws`.

Note: Historic shims under `src/server/services/*` and duplicate libs under `src/lib/*` were removed in favor of canonical modules in `src/server/*` and `src/db/*`.

---

## 9. Adding a New Feature

1. Create a folder in `src/features` (`kebab-case`).
2. Add hooks, utils, and components there (`components/`, `utils/`). Keep domain-specific utilities with the feature (e.g., `@features/health-data/utils`).
3. If you need API endpoints, add route handlers under `src/app/api/feature-name`.
4. Only use `src/lib` for cross-cutting, UI-agnostic helpers. Otherwise keep helpers inside the feature.

---

_Feel free to extend this document as the project evolves._

